#!/usr/bin/env bash

# Proxmox Server Setup Script
# Author: Daniel Brunod
# License: MIT
# This script is used for setting up a Proxmox server from scratch

header_info() {
  clear
  cat <<"EOF"

 ██████╗██████╗  █████╗ ███████╗████████╗███████╗
██╔════╝██╔══██╗██╔══██╗██╔════╝╚══██╔══╝╚══███╔╝
██║     ██████╔╝███████║█████╗     ██║     ███╔╝ 
██║     ██╔══██╗██╔══██║██╔══╝     ██║    ███╔╝  
╚██████╗██║  ██║██║  ██║██║        ██║   ███████╗
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝        ╚═╝   ╚══════╝                                              
          
      After Install Script for Proxmox
            by Daniel Brunod
         

EOF
}

# Colors for messages
RD=$(echo "\033[01;31m")
YW=$(echo "\033[33m")
GN=$(echo "\033[1;92m")
CL=$(echo "\033[m")
BFR="\\r\\033[K"
HOLD="-"
CM="${GN}✓${CL}"
CROSS="${RD}✗${CL}"

# Set script to exit on error and inherit the error flags
set -euo pipefail
shopt -s inherit_errexit nullglob

# Message functions
msg_info() {
  local msg="$1"
  echo -ne " ${HOLD} ${YW}${msg}..."
}

msg_ok() {
  local msg="$1"
  echo -e "${BFR} ${CM} ${GN}${msg}${CL}"
}

msg_error() {
  local msg="$1"
  echo -e "${BFR} ${CROSS} ${RD}${msg}${CL}"
}

# Function to update and upgrade Proxmox
update_proxmox() {
  msg_info "Updating Proxmox VE"
  apt update && apt upgrade -y &>/dev/null
  msg_ok "Proxmox VE Updated"
  echo ""
  read -p "Press Enter to continue..."
}

# Function to modify repositories (non-production and enterprise)
modify_repos() {
  local pve_repo_file="/etc/apt/sources.list"
  local enterprise_repo_file="/etc/apt/sources.list.d/pve-enterprise.list"
  local ceph_repo_file="/etc/apt/sources.list.d/ceph.list"

  msg_info "Checking existing repository configuration"

  # Display current repository configuration
  echo "Current Proxmox Repositories:"
  grep -E '^deb' $pve_repo_file || echo "No repositories found in $pve_repo_file"

  echo "Enterprise Repositories:"
  grep -E '^deb' $enterprise_repo_file || echo "No repositories found in $enterprise_repo_file"

  echo "Ceph Repositories:"
  grep -E '^deb' $ceph_repo_file || echo "No repositories found in $ceph_repo_file"

  echo ""
  read -p "Press Enter to continue..."

  CHOICE=$(whiptail --backtitle "Proxmox Server Setup" --title "Repository Configuration" --menu "Choose an action:" 15 60 4 \
  "1" "Switch to Non-Production Repositories" \
  "2" "Switch to Enterprise Repositories" \
  "3" "Exit to menu" 3>&2 2>&1 1>&3)

  case $CHOICE in
    1)  # Switch to Non-Production Repositories
      msg_info "Switching to Non-Production Repositories"

      # Backup current repository files
      cp $pve_repo_file ${pve_repo_file}.bak
      cp $enterprise_repo_file ${enterprise_repo_file}.bak
      cp $ceph_repo_file ${ceph_repo_file}.bak
      msg_ok "Backup created for repository files"

      # Check and descomentar ou incluir os repositórios não-produção
      if grep -q '^#deb http://download.proxmox.com/debian/pve' $pve_repo_file; then
        # Descomentar se estiver comentado
        sed -i 's|^#deb http://download.proxmox.com/debian/pve|deb http://download.proxmox.com/debian/pve|' $pve_repo_file
        msg_ok "Descomentado Proxmox non-production repository"
      elif ! grep -q '^deb http://download.proxmox.com/debian/pve' $pve_repo_file; then
        # Adicionar se não existir
        echo -e "\n# NOT recommended for production use" >> $pve_repo_file
        echo "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription" >> $pve_repo_file
        msg_ok "Adicionado Proxmox non-production repository"
      fi

      if grep -q '^#deb http://download.proxmox.com/debian/ceph-quincy' $pve_repo_file; then
        # Descomentar se estiver comentado
        sed -i 's|^#deb http://download.proxmox.com/debian/ceph-quincy|deb http://download.proxmox.com/debian/ceph-quincy|' $pve_repo_file
        msg_ok "Descomentado Ceph non-production repository"
      elif ! grep -q '^deb http://download.proxmox.com/debian/ceph-quincy' $pve_repo_file; then
        # Adicionar se não existir
        echo -e "\n# Not for production ceph" >> $pve_repo_file
        echo "deb http://download.proxmox.com/debian/ceph-quincy bookworm no-subscription" >> $pve_repo_file
        msg_ok "Adicionado Ceph non-production repository"
      fi

      # Comentar os repositórios enterprise
      sed -i 's|^deb https://enterprise.proxmox.com/debian/pve|#deb https://enterprise.proxmox.com/debian/pve|' $enterprise_repo_file
      sed -i 's|^deb https://enterprise.proxmox.com/debian/ceph|#deb https://enterprise.proxmox.com/debian/ceph|' $ceph_repo_file

      msg_ok "Switched to Non-Production Repositories"
      echo ""
      read -p "Press Enter to continue..."
      ;;
      
    2)  # Switch to Enterprise Repositories
      msg_info "Switching to Enterprise Repositories"

      # Comentar os repositórios não-produção
      sed -i 's|^deb http://download.proxmox.com/debian/pve|#deb http://download.proxmox.com/debian/pve|' $pve_repo_file
      sed -i 's|^deb http://download.proxmox.com/debian/ceph-quincy|#deb http://download.proxmox.com/debian/ceph-quincy|' $pve_repo_file

      # Descomentar os repositórios enterprise se estiverem comentados
      if grep -q '^#deb https://enterprise.proxmox.com/debian/pve' $enterprise_repo_file; then
        sed -i 's|^#deb https://enterprise.proxmox.com/debian/pve|deb https://enterprise.proxmox.com/debian/pve|' $enterprise_repo_file
        msg_ok "Descomentado Proxmox enterprise repository"
      fi

      if grep -q '^#deb https://enterprise.proxmox.com/debian/ceph' $ceph_repo_file; then
        sed -i 's|^#deb https://enterprise.proxmox.com/debian/ceph|deb https://enterprise.proxmox.com/debian/ceph|' $ceph_repo_file
        msg_ok "Descomentado Ceph enterprise repository"
      fi

      msg_ok "Switched to Enterprise Repositories"
      echo ""
      read -p "Press Enter to continue..."
      ;;
      
    3)  # Return to menu
      msg_info "Returning to the main menu"
      ;;
  esac
}

# Main menu loop
main_menu() {
  while true; do
    CHOICE=$(whiptail --backtitle "Proxmox Server Setup" --title "Main Menu" --menu "Choose an option:" 15 60 4 \
    "1" "Update and Upgrade Proxmox" \
    "2" "Modify DNS Configuration" \
    "3" "Modify Repositories" \
    "4" "Exit" 3>&2 2>&1 1>&3)

    case $CHOICE in
      1)
        update_proxmox
        ;;
      2)
        modify_dns
        ;;
      3)
        modify_repos
        ;;
      4)
        clear
        exit 0
        ;;
      *)
        echo "Invalid option, please select again."
        ;;
    esac
  done
}

# Start the script
header_info
main_menu
